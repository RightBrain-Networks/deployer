{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Network Security Groups.",
  "Parameters": {
    "Environment": {
      "Description": "Environment name assigned to EC2 instances (e.g. 'prod' or 'test').",
      "Type": "String",
      "Default": "",
      "ConstraintDescription": "Must be a string."
    },
    "Project" : {
      "Description" : "Project name.",
      "Type" : "String",
      "Default" : "",
      "ConstraintDescription" : "Must be a string."
    },
    "VPCCIDR": {
      "Description": "VPCCIDR",
      "Type": "String",
      "Default" : ""
    },
    "VPC": {
      "Description": "VPC ID",
      "Type": "AWS::EC2::VPC::Id"
    },
    "Role" : {
      "Description": "Role",
      "Type": "String",
      "Default": "webapp"
    }
  },
  "Resources": {
    "ALBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Enable ELB.",
        "VpcId": { "Ref": "VPC" },
        "SecurityGroupIngress": [
          { "IpProtocol": "tcp", "FromPort": "5001", "ToPort": "5010", "CidrIp": { "Ref": "VPCCIDR" }},
          { "IpProtocol": "tcp", "FromPort": "80", "ToPort": "80", "CidrIp": "0.0.0.0/0" }
        ],
        "SecurityGroupEgress": [
          { "IpProtocol": "tcp", "FromPort": "0", "ToPort": "65535", "SourceSecurityGroupId": { "Ref" : "ECSClusterSecurityGroup" }},
          { "IpProtocol": "tcp", "FromPort": "80", "ToPort": "80", "SourceSecurityGroupId": { "Ref" : "ECSClusterSecurityGroup" }},
          { "IpProtocol": "tcp", "FromPort": "443", "ToPort": "443", "SourceSecurityGroupId": { "Ref" : "ECSClusterSecurityGroup"}}
        ],
        "Tags" : [
          { "Key" : "Name", "Value": "ECS-ALB" }
        ]
      }
    },
    "ECSClusterSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "ECS Cluster Security Group.",
        "VpcId": { "Ref": "VPC" },
        "SecurityGroupIngress": [
          { "IpProtocol": "tcp", "FromPort": "0", "ToPort": "65535", "CidrIp": { "Ref": "VPCCIDR" }},
          { "IpProtocol": "tcp", "FromPort": "80", "ToPort": "80", "CidrIp": { "Ref": "VPCCIDR" }},
          { "IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": { "Ref": "VPCCIDR" }},
          { "IpProtocol": "tcp", "FromPort": "443", "ToPort": "443", "CidrIp": { "Ref": "VPCCIDR" }}
        ],
        "SecurityGroupEgress": [
          { "IpProtocol": "icmp", "FromPort": "-1", "ToPort": "-1", "CidrIp": "0.0.0.0/0" },
          { "IpProtocol": "tcp", "FromPort": "0", "ToPort": "65535", "CidrIp": "0.0.0.0/0" },
          { "IpProtocol": "udp", "FromPort": "0", "ToPort": "65535", "CidrIp": "0.0.0.0/0" }
        ],
        "Tags" : [
          { "Key" : "Name", "Value": "ECS-Cluster" }
        ]
      }
    },
    "EFSSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "ECS Cluster Security Group.",
        "VpcId": { "Ref": "VPC" },
        "SecurityGroupIngress": [
          { "IpProtocol": "tcp", "FromPort": "2049", "ToPort": "2049", "CidrIp": { "Ref": "VPCCIDR" }}
        ],
        "SecurityGroupEgress": [
        ],
        "Tags" : [
          { "Key" : "Name", "Value": "EFS-Mount-Point" }
        ]
      }
    },
    "RDSSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "RDS Cluster Security Group.",
        "VpcId": { "Ref": "VPC" },
        "SecurityGroupIngress": [
          { "IpProtocol": "tcp", "FromPort": "3306", "ToPort": "3306", "CidrIp": { "Ref": "VPCCIDR" }}
        ],
        "SecurityGroupEgress": [
        ],
        "Tags" : [
          { "Key" : "Name", "Value": "RDS-Cluster-Security-Group" }
        ]
      }
    },
    "RedisCacheSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable communication to Redis ElastiCache.",
        "VpcId" : { "Ref" : "VPC" },
        "SecurityGroupIngress" : [
          { "IpProtocol" : "tcp", "FromPort" : "6379", "ToPort" : "6379", "CidrIp" : { "Ref": "VPCCIDR" } },
        ],
        "SecurityGroupEgress" : [
        ],
        "Tags" : [
          { "Key" : "Name", "Value": { "Fn::Join": [ "-", [ { "Ref": "Environment" }, "ElastiCache", "Redis" ] ] } }
        ]
      }
    }
  },
  "Outputs": {
    "ALBSecurityGroup": {
      "Description": "ALB Security Group ID",
      "Value": { "Ref": "ALBSecurityGroup" }
    },
    "ECSClusterSecurityGroup": {
      "Description": "ECS Cluster Security Group ID",
      "Value": { "Ref": "ECSClusterSecurityGroup" }
    },
    "EFSSecurityGroup": {
      "Description": "EFS Mount Point Security Group ID",
      "Value": { "Ref": "EFSSecurityGroup" }
    },
    "RDSSecurityGroup": {
      "Description": "RDS Security groups",
      "Value": { "Ref": "RDSSecurityGroup" }
    },
    "RedisCacheSecurityGroup": {
      "Description": "Redis Security Groups",
      "Value": { "Ref": "RedisCacheSecurityGroup" }
    }
  }
}
