{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Vibeio Service CloudFormation Stack",
  "Parameters": {
    "VPCCIDR": {
      "Description": "VPCCIDR",
      "Type": "String",
      "Default": "VPCCIDR for the application"
    },
    "VPC": {
      "Description": "VPC ID",
      "Type": "AWS::EC2::VPC::Id"
    },
    "Role" : {
      "Description": "Role",
      "Type": "String",
      "Default": "webapp"
    },
    "Project" : {
      "Description": "Project Name",
      "Type": "String",
      "Default": ""
    },
    "Environment": {
      "Description": "Environment name assigned to EC2 instances (e.g. 'prod' or 'test').",
      "Type": "String", 
      "Default": "Live",
      "ConstraintDescription": "Must be a string."
    },
    "PrivateDomain": {
      "Description": "Private domain name.",
      "Type": "String",
      "Default": ""
    },
    "PublicDomain": {
      "Description": "Public domain name.",
      "Type": "String",
      "Default": ""
    },
    "CloudToolsBucket": {
      "Description":"Name of S3 bucket containing CloudTools scripts.",
      "Type": "String",
      "Default": ""
    },
    "CommonBootstrapFile": {
      "Description": "Name of common bootstrap file to be used by many instances.",
      "Type": "String",
      "Default": "common.sh"
    },
    "Release" : {
      "Description" : "Release Number",
      "Type" : "String",
      "Default" : "0.0.1"
    },
    "SSLCertId": {
      "Description": "SSL Cert Id",
      "Type": "String",
      "Default": "",
      "ConstraintDescription": "Must be a Id."
    },
    "PrivateSubnetList": {
      "Description":"A list of subnet IDs in your VPC to attach to your EC2 instances.",
      "Type": "String"
    },
    "PublicSubnetList": {
      "Type": "String",
      "Description": "List of an existing subnet IDs to use for load balancer"
    },
    "ALBSubnetList": {
       "Description":"A list of subnet IDs in your VPC to attach to your EC2 instances.",
       "Type": "List<AWS::EC2::Subnet::Id>"
    },
    "RDSSubnetGroup": {
      "Type": "String",
      "Description": "List of existing subnet ID's to use with RDS"
    },
    "ECSCluster": {
      "Description": "Cluster we need to put services in",
      "Type": "String",
      "Default": ""
    },
    "CpuUnits": {
      "Type": "String",
      "Description": "The amount of Cpu alloted to the container. 1024 is a single core.",
      "ConstraintDescription" : "must be a string.",
      "Default": "300"
    },
    "MemoryUnits": {
      "Type": "String",
      "Description": "The amount of memory alloted to the container in megabytes.",
      "ConstraintDescription" : "must be a string.",
      "Default": "300"
    },
    "AMI": {
      "Type": "String",
      "Description": "ECS optimized AMI"
    },
    "LogHost": {
      "Type": "String",
      "Description": "Hosted Zone Name for the Route 53 Record",
      "Default": ""
    },
    "DBName": {
      "Type": "String",
      "Description": "Sample database name",
      "Default": ""
    },
    "DBHost": {
      "Type": "String",
      "Description": "Sample database host",
      "Default": ""
    },
    "DBUser": {
      "Type": "String",
      "Description": "Sample database username",
      "Default": ""
    },
    "DBPassword": {
      "Type": "String",
      "Description": "Sample database password",
      "Default": ""
    },
    "MaxCapacity": {
      "Description": "Max allowed ECS service instances",
      "Type": "Number",
      "Default": "4"
    },
    "MinCapacity": {
      "Description": "Min allowed ES service instances",
      "Type": "Number",
      "Default": "2"
    },
    "ECSClusterSecurityGroup": {
      "Description": "ECS Cluster Security Group",
      "Type": "String",
      "Default": ""
    },
    "DBSnapshotID": {
      "Description": "Database snapshot",
      "Type": "String",
      "Default": ""
    }
  },
  "Conditions": {
    "LambdaAvailable": { "Fn::Not": [
      { "Fn::Or": [
        { "Fn::Equals": [ { "Ref": "AWS::Region" }, "us-west-1" ] },
        { "Fn::Equals": [ { "Ref": "AWS::Region" }, "ap-southeast-1" ] },
        { "Fn::Equals": [ { "Ref": "AWS::Region" }, "ap-northeast-2" ] },
        { "Fn::Equals": [ { "Ref": "AWS::Region" }, "sa-east-1" ] }
      ]}
    ]},
    "IsRegionUSStandard": { "Fn::Equals": [ { "Ref": "AWS::Region" }, "us-east-1" ] },
    "NotProd": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "Environment" }, "Prod" ] } ] }
  },
  "Resources": {
    "IAM": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3", { "Fn::If": [ "IsRegionUSStandard", "", { "Fn::Join": [ "", [ "-", { "Ref": "AWS::Region" } ] ] } ] }, ".amazonaws.com/", { "Ref": "CloudToolsBucket" }, "/", { "Ref": "Release" }, "/cloudformation/services/vibeio/iam.json" ]] },
        "Parameters": {
          "CloudToolsBucket": { "Ref": "CloudToolsBucket" }
        }
      }
    },
    "SNS": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3", { "Fn::If": [ "IsRegionUSStandard", "", { "Fn::Join": [ "", [ "-", { "Ref": "AWS::Region" } ] ] } ] }, ".amazonaws.com/", { "Ref": "CloudToolsBucket" }, "/", { "Ref": "Release" }, "/cloudformation/services/vibeio/sns.json" ]] },
        "Parameters": {
          "Project": { "Ref": "Project" },
          "Environment": { "Ref": "Environment" }
        }
      }
    },
    "SecurityGroups": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3", { "Fn::If": [ "IsRegionUSStandard", "", { "Fn::Join": [ "", [ "-", { "Ref": "AWS::Region" } ] ] } ] }, ".amazonaws.com/", { "Ref": "CloudToolsBucket" }, "/", { "Ref": "Release" }, "/cloudformation/services/vibeio/security_groups.json" ]] },
        "Parameters": {
          "VPC": { "Ref": "VPC" },
          "VPCCIDR": { "Ref": "VPCCIDR" },
          "Project": { "Ref": "Project" },
          "Environment": { "Ref": "Environment" },
          "ECSClusterSecurityGroup": { "Ref": "ECSClusterSecurityGroup" }
        }
      }
    },
    "ApplicationLoadBalancer" : {
      "Type" : "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties" : {
        "Name": { "Fn::Join": ["-",[{ "Ref": "Environment" },{ "Ref": "Role" }, "ALB" ]]},
        "Subnets" : { "Ref" : "ALBSubnetList" },
        "SecurityGroups":  [{ "Fn::GetAtt": [ "SecurityGroups", "Outputs.ALBSecurityGroup" ] }]
      }
    },
    "ALBListener": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "DefaultActions": [{
          "Type": "forward",
          "TargetGroupArn": { "Ref": "TargetGroup" }
        }],
       "LoadBalancerArn": { "Ref": "ApplicationLoadBalancer" },
       "Port": 80,
       "Protocol": "HTTP"
      }
    },
    "TargetGroup" : {
      "Type" : "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties" : {
        "HealthCheckIntervalSeconds": 30,
        "HealthCheckProtocol": "HTTP",
        "HealthCheckTimeoutSeconds": 10,
        "HealthyThresholdCount": 4,
        "Matcher" : {
          "HttpCode" : "200"
        },
        "HealthCheckPath": "/Home",
        "Name": { "Fn::Join": ["-", ["Vibeio", { "Ref": "Environment" }, { "Ref": "Role" }]]},
        "Port": 7666,
        "Protocol": "HTTP",
        "TargetGroupAttributes": [{
          "Key": "deregistration_delay.timeout_seconds",
          "Value": "20"
        }],
        "VpcId": { "Ref" : "VPC" },
        "Tags" : [
          { "Key" : "Environment", "Value" : { "Ref": "Environment" }},
          { "Key" : "Role", "Value" : { "Ref": "Role" }}
        ]
      }
    },
    "ALBListenerRule1": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "TargetGroup"
            }
          }
        ],
        "Conditions": [
          { "Field": "path-pattern",
            "Values": ["/"]
          }
        ],
        "ListenerArn": { "Ref": "ALBListener" },
        "Priority": 1
      }
    },
    "Database": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3", { "Fn::If": [ "IsRegionUSStandard", "", { "Fn::Join": [ "", [ "-", { "Ref": "AWS::Region" } ] ] } ] }, ".amazonaws.com/", { "Ref" : "CloudToolsBucket" }, "/", { "Ref": "Release" }, "/cloudformation/common/mysqlmember.json" ] ] },
        "Parameters": {
	      "RDSSubnetGroup": { "Ref": "RDSSubnetGroup" },
	      "Environment": { "Ref": "Environment" },
	      "Project": { "Ref": "Project" },
	      "Release": { "Ref": "Release" },
          "DBUser": { "Ref": "DBUser" },
	      "DBPassword": { "Ref": "DBPassword" },
	      "Role": "db",
	      "RDSSecurityGroup": { "Fn::GetAtt": [ "SecurityGroups","Outputs.RDSSecurityGroup" ] },
          "DBSnapshotID": { "Ref": "DBSnapshotID" },
          "HostedZoneName": { "Ref": "PrivateDomain" }
        }
      }
   },
    "Vibeio": {
      "DependsOn" : "IAM",
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3", { "Fn::If": [ "IsRegionUSStandard", "", { "Fn::Join": [ "", [ "-", { "Ref": "AWS::Region" } ] ] } ] }, ".amazonaws.com/", { "Ref" : "CloudToolsBucket" }, "/", { "Ref": "Release" }, "/cloudformation/services/vibeio/ecs-service-alb.json" ] ] },
        "Parameters": {
          "IsELBInternal": "True",
          "Project": { "Ref": "Project" },
          "Role": { "Ref": "Role" },
          "VPC": { "Ref": "VPC" },
          "EcsCluster": { "Ref": "ECSCluster" },
          "ELBSubnetList" : { "Ref": "PublicSubnetList" },
          "Project": { "Ref": "Project" },
          "Environment": { "Ref": "Environment" },
          "Release": { "Ref": "Release" },
          "ContainerName": "Vibeio",
          "ContainerImage": "356438515751.dkr.ecr.us-east-1.amazonaws.com/vibeio:latest",
          "ContainerPort": "7666",
          "TargetGroup": { "Ref": "TargetGroup" },
          "ContainerMemory": { "Ref": "MemoryUnits" },
          "ContainerCpuUnits": { "Ref": "CpuUnits" },
          "InstancePort": "80",
          "InstanceListenerProtocol": "TCP",
          "PublicSubnetList": { "Ref": "PublicSubnetList" },
          "EcsServiceRole" : { "Fn::GetAtt": [ "IAM", "Outputs.ECSServiceRole" ] },
          "HostedZoneName" : { "Ref": "PrivateDomain" },
          "PrivateDomain" : { "Ref": "PrivateDomain" },
          "PublicDomain" : { "Ref": "PublicDomain" },
	      "ECSServiceMaxCapacity": { "Ref": "MaxCapacity" },
	      "ECSServiceMinCapacity": { "Ref": "MinCapacity" },
          "LogHost": { "Ref" : "LogHost" },
          "VolumeName": "user",
          "VolumeContainerPath": "/var/www/vibeio",
          "VolumeHostPath": "/mnt/efs/app/vibeio",
          "ExposeDockerDaemon": "False",
          "DBHost": { "Fn::GetAtt": [ "Database", "Outputs.DNSName" ] },
          "DBName": { "Ref": "DBName" },
          "DBUser": { "Ref": "DBUser" },
          "DBPassword": { "Ref": "DBPassword" }
        }
      }
    },
    "ALBEndpoint" : {
      "Type" : "AWS::Route53::RecordSet",
      "Properties" : {
        "HostedZoneName" :                      { "Fn::Join" : [ "", [ { "Ref": "PublicDomain" }, "." ]] },
        "Comment" :                             { "Fn::Join" : [ "", [ "DNS name for Gateway Endpoint in ", { "Ref": "Environment" } ]]},
        "Name" :                                { "Fn::Join" : [ "", ["dashboard", ".", { "Ref": "Environment" }, ".", { "Ref": "PublicDomain" }, "." ] ] },
        "Type" :                                "A",
        "AliasTarget": {
          "DNSName":                            { "Fn::GetAtt": [ "ApplicationLoadBalancer", "DNSName" ] },
          "HostedZoneId":                       { "Fn::GetAtt": [ "ApplicationLoadBalancer", "CanonicalHostedZoneID" ] },
          "EvaluateTargetHealth":               "False"
        }
      }
    }
  },
  "Outputs": {
    
  }
}
