{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Network Security Groups.",

  "Parameters": {
    "Environment": {
      "Description": "Environment name assigned to EC2 instances (e.g. 'prod' or 'test').",
      "Type": "String",
      "Default": "ENV",
      "ConstraintDescription": "Must be a string."
    },
    "Project" : {
      "Description" : "Project name.",
      "Type" : "String",
      "Default" : "PROJECT",
      "ConstraintDescription" : "Must be a string."
    },
    "VPC": {
      "Default": "",
      "Description": "VPC ID",
      "Type": "AWS::EC2::VPC::Id"
    },
    "VPCCIDR" : {
      "Description" : "CIDR block of the VPC.",
      "Type" : "String",
      "MinLength" : "9",
      "MaxLength" : "18",
      "Default" : "0.0.0.0/0",
      "AllowedPattern" : "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription" : "Must be valid CIDR notation (i.e. x.x.x.x/x)."
    },
    "VPNCIDR" : {
      "Description" : "CIDR block of the VPC.",
      "Type" : "String",
      "MinLength" : "9",
      "MaxLength" : "18",
      "Default" : "10.0.0.0/8",
      "AllowedPattern" : "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription" : "Must be valid CIDR notation (i.e. x.x.x.x/x)."
    },
    "BastionSSHFrom":{
      "Description":"Lockdown SSH access to the bastion host",
      "Type":"String",
      "MinLength":"9",
      "MaxLength":"18",
      "Default":"0.0.0.0/0",
      "AllowedPattern":"(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription":"must be a valid CIDR range of the form x.x.x.x/x."
    }
  },

  "Resources": {
    "BastionSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Enable communication to bastion host(s).",
        "VpcId": { "Ref": "VPC" },
        "SecurityGroupIngress": [
          { "IpProtocol": "icmp", "FromPort": "-1", "ToPort": "-1", "CidrIp": { "Ref": "VPCCIDR" } },
          { "IpProtocol": "icmp", "FromPort": "-1", "ToPort": "-1", "CidrIp": { "Ref": "VPNCIDR" } },
          { "IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": { "Ref": "BastionSSHFrom" } }
        ],
        "SecurityGroupEgress": [
          { "IpProtocol": "icmp", "FromPort": "-1", "ToPort": "-1", "CidrIp": "0.0.0.0/0" },
          { "IpProtocol": "tcp", "FromPort": "0", "ToPort": "65535", "CidrIp": "0.0.0.0/0" },
          { "IpProtocol": "udp", "FromPort": "0", "ToPort": "65535", "CidrIp": "0.0.0.0/0" }
        ],
        "Tags" : [
          { "Key" : "Name", "Value": "Bastion" }
        ]
      }
    }
  },
  "Outputs": {
    "BastionSecurityGroup": {
      "Description": "Bastion Security Group ID",
      "Value": { "Ref": "BastionSecurityGroup" }
    }
  }
}
